name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:

permissions:
  contents: read
  packages: write

jobs:
  rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip2
      - name: Cargo fmt
        run: cargo fmt --all -- --check
      - name: Cargo clippy
        run: cargo clippy --workspace --all-targets -- -D warnings
      - name: Cargo test
        run: cargo test --workspace --all-targets
      - name: Cargo check (wasm32-wasip2)
        run: cargo check --target wasm32-wasip2
      - name: Install cargo-component
        run: cargo install cargo-component --locked
      - name: Build WASM (release)
        run: |
          if cargo component --version >/dev/null 2>&1; then
            cargo component build --release --target wasm32-wasip2
          else
            cargo build --target wasm32-wasip2 --release
          fi
      - name: Prepare publish artifacts
        if: github.ref == 'refs/heads/master'
        run: |
          WASM_PATH="$(find target -type f -name component_templates.wasm ! -path '*/deps/*' | head -n1)"
          if [ -z "${WASM_PATH}" ]; then
            echo "component_templates.wasm not found under target/"
            exit 1
          fi
          cp "${WASM_PATH}" component_templates.wasm
          cp component.manifest.json component.publish.manifest.json
          jq '.artifacts.component_wasm = "component_templates.wasm"' component.publish.manifest.json > component.publish.tmp && mv component.publish.tmp component.publish.manifest.json
          python -m pip install --user blake3
          python - <<'PY'
          import json
          from pathlib import Path
          import blake3

          manifest = Path("component.publish.manifest.json")
          wasm_path = Path("component_templates.wasm")

          data = json.loads(manifest.read_text())
          digest = blake3.blake3(wasm_path.read_bytes()).hexdigest()
          data["hashes"]["component_wasm"] = f"blake3:{digest}"
          manifest.write_text(json.dumps(data, indent=2))
          PY
          ls -l component_templates.wasm component.publish.manifest.json
      - name: Install ORAS
        if: github.ref == 'refs/heads/master'
        uses: oras-project/setup-oras@v1
      - name: Login to GHCR
        if: github.ref == 'refs/heads/master'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: echo "${GITHUB_TOKEN}" | oras login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin
      - name: Push OCI artifact to GHCR
        if: github.ref == 'refs/heads/master'
        env:
          IMAGE: ghcr.io/greentic-ai/components/templates
        run: |
          VERSION=$(cargo metadata --no-deps --format-version=1 | jq -r '.packages[] | select(.name=="component-templates") | .version')
          oras push "${IMAGE}:latest" \
            --annotation org.opencontainers.image.source="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}" \
            component.publish.manifest.json:application/vnd.greentic.component.manifest+json \
            component_templates.wasm:application/wasm
          oras push "${IMAGE}:${VERSION}" \
            --annotation org.opencontainers.image.source="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}" \
            component.publish.manifest.json:application/vnd.greentic.component.manifest+json \
            component_templates.wasm:application/wasm
